#include "foreachtest.h"
#include "yats.h"

SETUP_YATS();

/*
static void test_while() {
    unsigned char expected[] = {
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            BCONST_T,
            BRF_8,
            0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            BCONST_T,
            POP,
            BR_8,
            0xEB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            HALT
    };
    ASSERT_GEN_BC_EQ(expected,"while true { true; };");
}
*/

static void test_continue() {
    unsigned char expected[] = {
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            END,
            ICONST,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            NEWLIST,
            INITFOR,
            ITER_1,
            BRF_8,
            0x2C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GSTORE_1, 0x06,
            GLOAD_1, 0x06,
            ICONST,
            0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            EQ,
            BRF_8,
            0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            BR_8,
            0xD6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            GLOAD_1, 0x06,
            PRINT,
            BR_8,
            0xCA, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            ENDFOR,
            HALT
    };
    ASSERT_GEN_BC_EQ(expected,"for let i <- [0, 1, 2, 3, 4, 5] { if i == 5 { continue; }; print i; };");
}

static void test_break() {
    unsigned char expected[] = {
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            END,
            ICONST,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            NEWLIST,
            INITFOR,
            ITER_1,
            BRF_8,
            0x2D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GSTORE_1, 0x06,
            GLOAD_1, 0x06,
            ICONST,
            0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            EQ,
            BRF_8,
            0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            BCONST_F,
            BR_8,
            0xD6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            GLOAD_1, 0x06,
            PRINT,
            BR_8,
            0xC9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            ENDFOR,
            HALT
    };
    ASSERT_GEN_BC_EQ(expected,"for let i <- [0, 1, 2, 3, 4, 5] { if i == 5 { break; }; print i; };");
}

int foreachtest(void) {
    test_continue();
    test_break();
    return __YASL_TESTS_FAILED__;
}