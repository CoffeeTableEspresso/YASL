#include "comprehensiontest.h"
#include "yats.h"

SETUP_YATS();

static void test_tablecomp() {
    unsigned char expected[] = {
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            END,
            END,
            ICONST,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            NEWLIST,
            INITFOR,
            ITER_1,
            BRF_8,
            0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GSTORE_1, 0x06,
            GLOAD_1, 0x06,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            MOD,
            ICONST,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            EQ,
            NOT,
            BRF_8,
            0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GLOAD_1, 0x06,
            GLOAD_1, 0x06,
            NEG,
            BR_8,
            0xC6, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            ENDFOR,
            NEWTABLE,
            PRINT,
            HALT
    };
    ASSERT_GEN_BC_EQ(expected,"print {i:-i for let i <- [1,2,3] if i % 2 != 0};");
}

static void test_listcomp() {
    unsigned char expected[] = {
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            END,
            END,
            ICONST,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            ICONST,
            0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            NEWLIST,
            INITFOR,
            ITER_1,
            BRF_8,
            0x2E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GSTORE_1, 0x06,
            GLOAD_1, 0x06,
            ICONST,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            MOD,
            ICONST,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            EQ,
            NOT,
            BRF_8,
            0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            GLOAD_1, 0x06,
            NEG,
            BR_8,
            0xC8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            ENDFOR,
            NEWLIST,
            PRINT,
            HALT
    };
    ASSERT_GEN_BC_EQ(expected,"print [-i for let i <- [1,2,3] if i % 2 != 0];");
}

int comprehensiontest(void) {
    test_listcomp();
    test_tablecomp();
    return __YASL_TESTS_FAILED__;
}