#include "iftest.h"
#include "yats.h"

SETUP_YATS();


static void test_if() {
	unsigned char expected[] = {
		0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_BRF_8,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_PRINT,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; };");
}

static void test_ifelse() {
	unsigned char expected[] = {
		0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_BRF_8,
		0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_PRINT,
		O_BR_8,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_PRINT,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; } else { echo false; };");
}

static void test_ifelseelseif() {
	unsigned char expected[] = {
		0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x3D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_BRF_8,
		0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_PRINT,
		O_BR_8,
		0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_BRF_8,
		0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_PRINT,
		O_BR_8,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_NCONST,
		O_PRINT,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; } elseif false { echo false; } else { echo undef; };");
}


int iftest(void) {
	test_if();
	test_ifelse();
	test_ifelseelseif();

	return __YASL_TESTS_FAILED__;
}
