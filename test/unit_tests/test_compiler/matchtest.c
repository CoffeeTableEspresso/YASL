#include "yats.h"
#include "matchtest.h"

SETUP_YATS();

static void test_simple() {
	unsigned char expected[] = {
		0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x7D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 'n', 'e',
		C_STR,
		0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'n', 'o', 't', ' ', 'o', 'n', 'e',
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_MATCH,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LIT,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LIT, 0x01,
		O_ECHO,
		O_BR_8,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		O_LIT, 0x02,
		O_ECHO,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 1; match x { 1 { echo 'one'; }; * { echo 'not one'; }; };");
}

static void test_list() {
	unsigned char expected[] = {
		0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x9F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 2,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'v', 'a', 'r',
		O_END,
		O_NEWLIST,
		O_LLOAD, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* first pattern */
		0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LS,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		P_ANY,
		O_LIT, 0x00,
		O_ECHO,
		O_BR_8,
		0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LS,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		O_LIT, 0x01,
		O_ECHO,
		O_BR_8,
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* third pattern */
		0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_VLS,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LIT, 0x02,
		O_ECHO,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = []; match x { [ *, * ] { echo 2; }; [ * ] { echo 1; }; [ ... ] { echo 'var'; }; };");
}

static void test_table() {
	unsigned char expected[] = {
		0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xCE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_STR,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'x',
		C_STR,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'y',
		C_INT_1, 2,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'v', 'a', 'r',
		O_END,
		O_NEWTABLE,
		O_LLOAD, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* first pattern */
		0x2D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_TABLE,
		0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LIT,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		P_LIT,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		O_LIT, 0x02,
		O_ECHO,
		O_BR_8,
		0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x2F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_TABLE,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LIT,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ANY,
		O_LIT, 0x03,
		O_ECHO,
		O_BR_8,
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* third pattern */
		0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_VTABLE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LIT, 0x04,
		O_ECHO,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = {}; match x { { .x: *, .y: * } { echo 2; }; { .x: * } { echo 1; }; { ... } { echo 'var'; }; };");
}

int matchtest(void) {
	test_simple();
	test_list();
	test_table();

	return __YASL_TESTS_FAILED__;
}
