#include "foreachtest.h"
#include "yats.h"

SETUP_YATS();

static void test_continue() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x5A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_END,
		O_ICONST_B1, 0,
		O_ICONST_B1, 1,
		O_ICONST_B1, 2,
		O_ICONST_B1, 3,
		O_ICONST_B1, 4,
		O_ICONST_B1, 5,
		O_NEWLIST,
		O_INITFOR,
		O_END,
		O_ITER_1,
		O_BRF_8,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LSTORE, 0x00,
		O_LLOAD, 0x00,
		O_ICONST_B1, 5,
		O_EQ,
		O_BRF_8,
		0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BR_8,
		0xDD, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		O_LLOAD, 0x00,
		O_PRINT,
		O_BR_8,
		0xD1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		O_ENDFOR,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "for i <- [0, 1, 2, 3, 4, 5] { if i == 5 { continue; }; echo i; };");
}

static void test_break() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x5B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_END,
		O_ICONST_B1, 0,
		O_ICONST_B1, 1,
		O_ICONST_B1, 2,
		O_ICONST_B1, 3,
		O_ICONST_B1, 4,
		O_ICONST_B1, 5,
		O_NEWLIST,
		O_INITFOR,
		O_END,
		O_ITER_1,
		O_BRF_8,
		0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LSTORE, 0x00,
		O_LLOAD, 0x00,
		O_ICONST_B1, 5,
		O_EQ,
		O_BRF_8,
		0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_BR_8,
		0xDD, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		O_LLOAD, 0x00,
		O_PRINT,
		O_BR_8,
		0xD0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		O_ENDFOR,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "for i <- [0, 1, 2, 3, 4, 5] { if i == 5 { break; }; echo i; };");
}

int foreachtest(void) {
	test_continue();
	test_break();
	return __YASL_TESTS_FAILED__;
}
